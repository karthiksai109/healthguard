<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HealthGuard — Private AI Health Agent | 24/7 on Akash</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#f4f7fb;--surface:#fff;--card:#fff;--border:#e4ebf3;--accent:#1f7a8c;--green:#2f855a;--yellow:#b7791f;--red:#c53030;--text:#1a202c;--muted:#5a6b82;--chat-user:#e8f4fd;--chat-ai:#f0fdf4}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:"Inter",system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.mono{font-family:SFMono-Regular,Menlo,Monaco,Consolas,monospace}

/* Auth overlay */
.auth-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg,#0f172a,#1e3a5f);z-index:1000;display:flex;align-items:center;justify-content:center}
.auth-overlay.hidden{display:none}
.auth-box{background:#fff;border-radius:20px;padding:40px;max-width:440px;width:92%;box-shadow:0 25px 80px rgba(0,0,0,.3);text-align:center}
.auth-box h1{font-size:28px;color:var(--accent);letter-spacing:1px;margin-bottom:2px}
.auth-box .tagline{font-size:11px;color:var(--muted);margin-bottom:6px}
.auth-box .uptime-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:20px;font-size:10px;color:var(--green);font-weight:600;margin-bottom:24px}
.auth-box .uptime-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%{transform:scale(1);opacity:1}50%{transform:scale(2.5);opacity:.4}100%{transform:scale(1);opacity:1}}
.auth-tabs{display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:20px}
.auth-tabs button{flex:1;padding:10px;border:none;background:#f8fafc;color:var(--muted);font-size:12px;font-weight:600;cursor:pointer;transition:.2s}
.auth-tabs button.active{background:var(--accent);color:#fff}
.auth-field{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;outline:none;transition:.2s;margin-bottom:12px}
.auth-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(31,122,140,.15)}
.auth-btn{width:100%;padding:12px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-size:14px;font-weight:600;cursor:pointer;transition:.2s}
.auth-btn:hover{background:#165c6e}
.auth-btn:disabled{opacity:.5;cursor:not-allowed}
.auth-msg{font-size:11px;margin-top:12px;padding:8px;border-radius:6px;display:none}
.auth-msg.show{display:block}
.auth-msg.success{background:#f0fdf4;border:1px solid #bbf7d0;color:var(--green)}
.auth-msg.error{background:#fff5f5;border:1px solid #fed7d7;color:var(--red)}
.access-key-display{background:#fffbeb;border:2px dashed #f59e0b;border-radius:10px;padding:16px;margin:16px 0;text-align:center}
.access-key-display .key{font-size:32px;font-weight:700;letter-spacing:6px;color:var(--text);font-family:monospace}
.access-key-display .label{font-size:11px;color:var(--yellow);margin-top:6px}
.privacy-note{display:flex;align-items:flex-start;gap:8px;padding:10px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;font-size:10px;color:#166534;text-align:left;line-height:1.5;margin-top:12px}

/* Header */
.header{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:10px 20px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.95);backdrop-filter:blur(12px)}
.logo{display:flex;align-items:center;gap:10px}
.logo h1{font-size:16px;letter-spacing:1px;color:var(--accent)}
.logo .badge-24{background:var(--green);color:#fff;font-size:8px;font-weight:700;padding:2px 6px;border-radius:3px;letter-spacing:.5px}
.nav{display:flex;gap:6px;font-size:11px}
.nav a{color:var(--muted);text-decoration:none;text-transform:uppercase;letter-spacing:1px;padding:6px 10px;border-radius:6px;border:1px solid transparent;cursor:pointer}
.nav a.active{color:var(--accent);background:rgba(0,212,255,.1);border-color:rgba(0,212,255,.3)}
.header-right{display:flex;align-items:center;gap:12px;font-size:10px;color:var(--muted)}
.user-info{display:flex;align-items:center;gap:8px;padding:4px 10px;background:#f8fafc;border:1px solid var(--border);border-radius:6px}
.user-info .name{font-weight:600;color:var(--text)}
.user-info .key{font-family:monospace;color:var(--accent);font-size:9px}
.logout-btn{padding:4px 10px;border:1px solid var(--red);color:var(--red);border-radius:6px;background:none;cursor:pointer;font-size:10px;font-weight:600}
.logout-btn:hover{background:#fff5f5}

/* Status bar */
.status-bar{display:flex;gap:16px;padding:8px 20px;border-bottom:1px solid var(--border);background:var(--surface);font-size:10px;color:var(--muted);font-family:monospace;align-items:center;flex-wrap:wrap}
.status-pill{display:flex;align-items:center;gap:6px}
.status-pill strong{color:var(--text);font-weight:600}
.pulse-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px rgba(47,133,90,.4);animation:pulse 2s infinite}

/* Pages */
.page{display:none}.page.active{display:block}

/* Cards */
.grid{padding:16px 20px;display:grid;gap:16px}
.vitals{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;box-shadow:0 4px 16px rgba(20,30,60,.06)}
.card-title{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.metric-value{font-size:28px;font-weight:700;color:var(--text)}
.metric-sub{font-size:10px;color:var(--muted)}
.badge{font-size:9px;padding:3px 6px;border-radius:4px;letter-spacing:1px;font-family:monospace}
.badge.green{background:rgba(47,133,90,.12);color:var(--green)}
.badge.yellow{background:rgba(183,121,31,.12);color:var(--yellow)}
.badge.red{background:rgba(197,48,48,.12);color:var(--red)}
.card.status-normal{background:#fff;border-color:#e4ebf3}
.card.status-watch{background:linear-gradient(135deg,#fff,#fff7e6);border-color:#b7791f44}
.card.status-alert{background:linear-gradient(135deg,#fff,#ffe8e8);border-color:#c5303044;animation:alertPulse 2.5s ease-in-out infinite}
.card.status-watch .metric-value{color:var(--yellow)}
.card.status-alert .metric-value{color:var(--red)}
@keyframes alertPulse{0%,100%{box-shadow:0 0 20px rgba(255,68,102,.1)}50%{box-shadow:0 0 30px rgba(255,68,102,.2)}}

.main-grid{display:grid;grid-template-columns:1.2fr 1fr 300px;gap:16px}
.empty-state{text-align:center;padding:24px;color:var(--muted);font-size:12px}
.empty-state .icon{font-size:28px;margin-bottom:8px}

/* Vital input */
.vital-input-row{display:flex;gap:8px;align-items:center;margin-top:8px}
.vital-input-row input,.vital-input-row select{padding:8px;border:1px solid var(--border);border-radius:6px;font-size:12px}
.vital-input-row input{width:80px}

/* Chat */
.chat-container{display:flex;flex-direction:column;height:calc(100vh - 100px);max-width:860px;margin:0 auto;padding:0 20px}
.chat-messages{flex:1;overflow-y:auto;padding:20px 0;display:flex;flex-direction:column;gap:12px}
.chat-msg{max-width:80%;padding:12px 16px;border-radius:16px;font-size:13px;line-height:1.6;word-wrap:break-word;animation:fadeIn .3s ease}
.chat-msg.user{align-self:flex-end;background:var(--chat-user);border-bottom-right-radius:4px;color:var(--text)}
.chat-msg.assistant{align-self:flex-start;background:var(--chat-ai);border-bottom-left-radius:4px;color:var(--text)}
.chat-msg .time{font-size:9px;color:var(--muted);margin-top:4px}
.chat-msg .vitals-extracted{margin-top:8px;padding:8px;background:rgba(31,122,140,.08);border-radius:6px;font-size:10px;color:var(--accent)}
.chat-welcome{text-align:center;padding:40px 20px;color:var(--muted)}
.chat-welcome h2{font-size:24px;color:var(--text);margin-bottom:8px}
.chat-welcome .suggestions{display:grid;grid-template-columns:1fr 1fr;gap:8px;max-width:500px;margin:20px auto 0}
.chat-welcome .suggestion{padding:12px;background:#fff;border:1px solid var(--border);border-radius:10px;cursor:pointer;text-align:left;font-size:12px;color:var(--text);transition:.2s}
.chat-welcome .suggestion:hover{border-color:var(--accent);background:rgba(31,122,140,.04)}
.chat-welcome .suggestion .icon{font-size:18px;margin-bottom:4px}
.chat-input-wrap{padding:12px 0;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.chat-input-wrap textarea{flex:1;padding:12px 14px;border:1px solid var(--border);border-radius:12px;font-size:13px;outline:none;resize:none;min-height:44px;max-height:120px;font-family:inherit;transition:.2s}
.chat-input-wrap textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(31,122,140,.1)}
.chat-btn{width:40px;height:40px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-btn:disabled{opacity:.4;cursor:not-allowed}
.chat-btn.attach{background:#fff;border:1px solid var(--border);color:var(--text);font-size:20px}
.typing-indicator{align-self:flex-start;padding:12px 20px;background:var(--chat-ai);border-radius:16px;display:none}
.typing-indicator.show{display:flex;gap:4px}
.typing-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);animation:typing 1.4s infinite}
.typing-dot:nth-child(2){animation-delay:.2s}
.typing-dot:nth-child(3){animation-delay:.4s}
@keyframes typing{0%,100%{opacity:.3;transform:scale(.8)}50%{opacity:1;transform:scale(1)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* Buttons */
.btn{padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--text);font-size:11px;cursor:pointer;transition:.2s;width:100%}
.btn:hover{border-color:var(--accent);background:rgba(31,122,140,.06)}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);font-weight:600}
.btn.primary:disabled{opacity:.5;cursor:not-allowed}
.btn.small{width:auto;padding:6px 10px;font-size:10px}
.btn.toggle-active{border-color:var(--accent);color:var(--accent);background:rgba(0,212,255,.08)}

/* Feed & actions */
.actions-list,.feed-list{display:flex;flex-direction:column;gap:8px;max-height:280px;overflow-y:auto}
.action-item{border-left:3px solid var(--border);padding:8px 12px;background:#fff;border-radius:8px;font-size:10px;color:var(--muted)}
.action-item.red{border-left-color:var(--red)}
.action-item.yellow{border-left-color:var(--yellow)}
.action-item.green{border-left-color:var(--green)}
.feed-item{font-size:10px;color:var(--muted);animation:fadeIn .3s ease;font-family:monospace}

/* History */
.history-item{padding:12px;border:1px solid var(--border);border-radius:8px;background:#fff;margin-bottom:8px}
.history-item .time{font-size:10px;color:var(--muted);font-family:monospace}
.history-item .type{font-size:9px;padding:2px 6px;border-radius:4px;text-transform:uppercase;font-weight:600}

/* Doctor */
.doctor-section{padding:16px;margin-bottom:12px;border:1px solid var(--border);border-radius:10px;background:#fff}
.doctor-section h3{font-size:14px;color:var(--accent);margin-bottom:8px}
.doctor-section p{font-size:12px;line-height:1.6;color:var(--text)}

/* Chart */
.chart-wrap{height:200px}
.bp-line{stroke-dasharray:1000;stroke-dashoffset:1000;animation:draw 1.5s ease forwards}
@keyframes draw{to{stroke-dashoffset:0}}

.footer{padding:12px 20px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);text-align:center}
.error-banner{display:none;padding:8px 12px;margin:8px 20px;border:1px solid var(--red);color:var(--red);font-size:11px;border-radius:6px;background:#fff5f5}
.error-banner.show{display:block}

/* Doctor cards */
.doc-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;display:flex;gap:14px;align-items:flex-start;transition:.2s}
.doc-card:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(31,122,140,.1)}
.doc-card .avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#2dd4bf);display:flex;align-items:center;justify-content:center;color:#fff;font-size:20px;font-weight:700;flex-shrink:0}
.doc-card .info{flex:1}
.doc-card .info .name{font-size:14px;font-weight:600;color:var(--text)}
.doc-card .info .spec{font-size:11px;color:var(--accent);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.doc-card .info .meta{font-size:10px;color:var(--muted);margin-top:4px;display:flex;gap:12px;flex-wrap:wrap}
.doc-card .info .rate{font-size:13px;font-weight:700;color:var(--green);margin-top:4px}
.doc-card .actions{display:flex;flex-direction:column;gap:6px;align-items:flex-end}
.consult-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.consult-card .status-tag{font-size:9px;padding:2px 8px;border-radius:4px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.consult-card .status-tag.requested{background:#fff7e6;color:var(--yellow)}
.consult-card .status-tag.approved{background:#f0fdf4;color:var(--green)}
.consult-card .status-tag.denied{background:#fff5f5;color:var(--red)}
.consult-card .status-tag.completed{background:#ebf8ff;color:var(--accent)}
.alert-suggest{background:linear-gradient(135deg,#fff5f5,#fff);border:1px solid #fed7d7;border-radius:10px;padding:14px;margin-top:12px;animation:fadeIn .3s ease}
.alert-suggest .title{font-size:12px;font-weight:600;color:var(--red);margin-bottom:6px}
/* Doctor reg form fields */
.doc-reg-field{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:8px;font-size:13px;outline:none;margin-bottom:10px;transition:.2s}
.doc-reg-field:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(31,122,140,.15)}

@media(max-width:1024px){.main-grid{grid-template-columns:1fr 1fr}.vitals{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.vitals{grid-template-columns:1fr}.main-grid{grid-template-columns:1fr}.header{flex-direction:column;align-items:flex-start;gap:8px}.chat-welcome .suggestions{grid-template-columns:1fr}}
</style>
</head>
<body>

<!-- ==================== AUTH SCREEN ==================== -->
<div id="authOverlay" class="auth-overlay">
  <div class="auth-box">
    <h1>HEALTHGUARD</h1>
    <div class="tagline">Private AI Health Agent on Akash Decentralized Cloud</div>
    <div class="uptime-badge"><span class="dot"></span> ONLINE 24/7 on Akash Network</div>

    <div class="auth-tabs">
      <button class="active" id="tabLogin">Login</button>
      <button id="tabRegister">New Patient</button>
      <button id="tabDoctor">I'm a Doctor</button>
    </div>

    <!-- Login Form -->
    <div id="loginForm">
      <input class="auth-field" id="loginKey" type="text" placeholder="Enter your 6-character access key" maxlength="6" style="text-transform:uppercase;text-align:center;font-size:18px;letter-spacing:4px;font-family:monospace">
      <button class="auth-btn" id="loginBtn">Login Securely</button>
      <div class="privacy-note" style="margin-top:16px">
        <span style="font-size:16px">&#128274;</span>
        <span>No passwords. No emails. Just your unique access key. Your data is encrypted with AES-256-GCM and only accessible with this key.</span>
      </div>
    </div>

    <!-- Register Form -->
    <div id="registerForm" style="display:none">
      <input class="auth-field" id="regName" type="text" placeholder="Enter your full name">
      <button class="auth-btn" id="regBtn">Register & Get Access Key</button>
      <div id="regResult" style="display:none">
        <div class="access-key-display">
          <div class="label">YOUR UNIQUE ACCESS KEY</div>
          <div class="key" id="newAccessKey"></div>
          <div class="label" style="color:var(--red);margin-top:8px">&#9888; SAVE THIS KEY! You need it to log back in.</div>
        </div>
        <button class="auth-btn" id="regContinueBtn" style="margin-top:8px">Continue to Dashboard</button>
      </div>
      <div class="privacy-note">
        <span style="font-size:16px">&#128274;</span>
        <span>Your name is encrypted with AES-256-GCM before storage. Even if the database is stolen, your identity is unreadable.</span>
      </div>
    </div>

    <!-- Doctor Form -->
    <div id="doctorForm" style="display:none">
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn small toggle-active" id="docLoginTab" style="flex:1">Doctor Login</button>
        <button class="btn small" id="docRegTab" style="flex:1">Register as Doctor</button>
      </div>
      <div id="docLoginPanel">
        <input class="auth-field" id="docLoginKey" type="text" placeholder="Enter your doctor access key (DR...)" maxlength="6" style="text-transform:uppercase;text-align:center;font-size:18px;letter-spacing:4px;font-family:monospace">
        <button class="auth-btn" id="docLoginBtn">Login as Doctor</button>
      </div>
      <div id="docRegPanel" style="display:none">
        <input class="doc-reg-field" id="docRegName" type="text" placeholder="Full Name (Dr. Jane Smith)">
        <input class="doc-reg-field" id="docRegEmail" type="email" placeholder="Gmail (patients will see this)">
        <select class="doc-reg-field" id="docRegSpec">
          <option value="">Select Specialization</option>
          <option value="General Medicine">General Medicine</option>
          <option value="Cardiology">Cardiology</option>
          <option value="Endocrinology">Endocrinology</option>
          <option value="Pulmonology">Pulmonology</option>
          <option value="Dermatology">Dermatology</option>
          <option value="Orthopedics">Orthopedics</option>
          <option value="Neurology">Neurology</option>
          <option value="Psychiatry">Psychiatry</option>
          <option value="Pediatrics">Pediatrics</option>
          <option value="Oncology">Oncology</option>
        </select>
        <input class="doc-reg-field" id="docRegRate" type="text" placeholder="Pay Rate (e.g. $50/consultation)">
        <textarea class="doc-reg-field" id="docRegBio" placeholder="Short bio (optional)" rows="2" style="resize:none;font-family:inherit"></textarea>
        <div style="margin-bottom:12px">
          <label style="font-size:11px;color:var(--muted);display:block;margin-bottom:4px">Upload MBBS Certificate (PDF/Image)</label>
          <input type="file" id="docRegCert" accept=".pdf,.jpg,.jpeg,.png,.webp" style="font-size:12px">
        </div>
        <button class="auth-btn" id="docRegBtn">Register & Get Doctor Key</button>
        <div id="docRegResult" style="display:none">
          <div class="access-key-display">
            <div class="label">YOUR DOCTOR ACCESS KEY</div>
            <div class="key" id="newDocKey"></div>
            <div class="label" style="color:var(--red);margin-top:8px">&#9888; SAVE THIS! Starts with DR. Use it to log in.</div>
          </div>
          <button class="auth-btn" id="docRegContinueBtn" style="margin-top:8px">Continue to Doctor Dashboard</button>
        </div>
      </div>
      <div class="privacy-note">
        <span style="font-size:16px">&#129658;</span>
        <span>Doctor accounts are verified via MBBS certificate hash. Patient data is ONLY accessible when the patient explicitly approves your consultation request.</span>
      </div>
    </div>

    <div id="authMsg" class="auth-msg"></div>
  </div>
</div>

<!-- ==================== MAIN APP (hidden until login) ==================== -->
<div id="mainApp" style="display:none">

<div class="header">
  <div class="logo">
    <h1>HEALTHGUARD</h1>
    <span class="badge-24">24/7</span>
  </div>
  <div class="nav" id="navTabs">
    <a class="active" href="#" data-page="dashboard">Dashboard</a>
    <a href="#" data-page="chat">Health Chat</a>
    <a href="#" data-page="history">History</a>
    <a href="#" data-page="finddoc">Find Doctor</a>
    <a href="#" data-page="doctor">AI Report</a>
    <a href="#" data-page="docdash" style="display:none">Doctor Dashboard</a>
    <a href="#" data-page="privacy">Privacy</a>
  </div>
  <div class="header-right">
    <div class="user-info">
      <span class="name" id="userName">--</span>
      <span class="key" id="userKey">--</span>
    </div>
    <button class="logout-btn" id="logoutBtn">Logout</button>
  </div>
</div>

<div id="errorBanner" class="error-banner">Agent unreachable</div>

<!-- ==================== DASHBOARD ==================== -->
<div id="page-dashboard" class="page active">
  <div class="status-bar">
    <div class="status-pill"><span class="pulse-dot"></span><strong id="agentStatus">RUNNING</strong></div>
    <div class="status-pill">Uptime: <strong id="uptime">--</strong></div>
    <div class="status-pill"><strong style="color:var(--green)">24/7 on Akash</strong></div>
    <div class="status-pill">Storage: <strong>/data (encrypted)</strong></div>
  </div>
  <div class="grid">
    <div class="vitals">
      <div class="card status-normal" id="cardBp"><div class="card-title">Blood Pressure</div><div style="display:flex;align-items:center;justify-content:space-between"><div><div class="metric-value" id="bpValue">--</div><div class="metric-sub" id="bpTrend">No readings yet</div></div><div class="badge green" id="bpBadge">--</div></div></div>
      <div class="card status-normal" id="cardGlucose"><div class="card-title">Glucose</div><div style="display:flex;align-items:center;justify-content:space-between"><div><div class="metric-value" id="glucoseValue">--</div><div class="metric-sub" id="glucoseTrend">No readings yet</div></div><div class="badge green" id="glucoseBadge">--</div></div></div>
      <div class="card status-normal" id="cardPain"><div class="card-title">Pain Level</div><div style="display:flex;align-items:center;justify-content:space-between"><div><div class="metric-value" id="painValue">--</div><div class="metric-sub" id="painTrend">No readings yet</div></div><div class="badge green" id="painBadge">--</div></div></div>
      <div class="card status-normal" id="cardTemp"><div class="card-title">Temperature</div><div style="display:flex;align-items:center;justify-content:space-between"><div><div class="metric-value" id="tempValue">--</div><div class="metric-sub" id="tempTrend">No readings yet</div></div><div class="badge green" id="tempBadge">--</div></div></div>
    </div>
    <div class="card">
      <div class="card-title">Quick Add Vital Reading</div>
      <div class="vital-input-row">
        <select id="vitalType"><option value="bp">Blood Pressure</option><option value="glucose">Glucose</option><option value="pain_level">Pain Level</option><option value="temperature">Temperature</option><option value="heart_rate">Heart Rate</option><option value="oxygen_saturation">O2 Saturation</option></select>
        <input id="vitalVal1" placeholder="Value" type="number" step="any">
        <input id="vitalVal2" placeholder="/dia" type="number" step="any" style="display:none">
        <button class="btn small primary" id="addVitalBtn">Save</button>
        <span id="vitalSaveMsg" style="font-size:10px;color:var(--green)"></span>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px">Tip: You can also tell the Health Chat your vitals and they'll be auto-extracted!</div>
    </div>
    <div class="main-grid">
      <div>
        <div class="card"><div class="card-title">BP Trend (7 days)</div><div class="chart-wrap" id="bpChart"><div class="empty-state"><div class="icon">&#128200;</div>Add BP readings to see your trend</div></div></div>
        <div class="card" style="margin-top:16px"><div class="card-title">Alerts & Actions</div><div class="actions-list" id="actionsList"><div class="empty-state"><div class="icon">&#128276;</div>No alerts yet</div></div></div>
      </div>
      <div>
        <div class="card">
          <div class="card-title">Talk to Your Health AI</div>
          <div style="font-size:13px;color:var(--text);line-height:1.6;margin-bottom:12px">Chat with your private AI health assistant. Describe symptoms, ask questions, or upload health photos for instant analysis.</div>
          <button class="btn primary" id="goChat">Open Health Chat</button>
        </div>
        <div class="card" style="margin-top:16px"><div class="card-title">Recent Analysis</div><div id="recentAnalysis"><div class="empty-state"><div class="icon">&#128300;</div>Chat or upload a photo to get AI analysis</div></div></div>
      </div>
      <div>
        <div class="card">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="pulse-dot"></div><div class="card-title" style="margin:0">Live Updates</div></div>
          <div class="feed-list" id="feedList"><div class="empty-state" style="padding:12px"><div class="icon">&#128225;</div>Events appear here</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== HEALTH CHAT ==================== -->
<div id="page-chat" class="page">
  <div class="chat-container">
    <div class="chat-messages" id="chatMessages">
      <div class="chat-welcome" id="chatWelcome">
        <h2>How can I help with your health today?</h2>
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px">I'm your private AI health assistant, running 24/7 on Akash decentralized cloud.</div>
        <div style="font-size:10px;color:var(--accent)">Your conversations are encrypted. Photos are NEVER stored.</div>
        <div class="suggestions">
          <div class="suggestion" data-msg="My blood pressure is 140/90 and I have a headache"><div class="icon">&#128138;</div>Report vitals & symptoms</div>
          <div class="suggestion" data-msg="I have a wound on my arm that looks infected, can you analyze a photo?"><div class="icon">&#128247;</div>Analyze a health photo</div>
          <div class="suggestion" data-msg="I've been feeling very tired and my glucose was 210 this morning"><div class="icon">&#128200;</div>Track health changes</div>
          <div class="suggestion" data-msg="Can you summarize my health status and what I should tell my doctor?"><div class="icon">&#129658;</div>Prepare for doctor visit</div>
        </div>
      </div>
    </div>
    <div class="typing-indicator" id="typingIndicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>
    <div class="chat-input-wrap">
      <button class="chat-btn attach" id="chatAttachBtn" title="Attach health photo">&#128206;</button>
      <input type="file" id="chatPhotoInput" accept="image/*" style="display:none">
      <textarea id="chatInput" placeholder="Describe your symptoms, ask health questions, or share vitals..." rows="1"></textarea>
      <button class="chat-btn" id="chatSendBtn" title="Send">&#10148;</button>
    </div>
    <div style="text-align:center;font-size:9px;color:var(--muted);padding:4px 0">&#128274; Encrypted conversation. Photos analyzed by Venice AI (zero retention) then deleted. Chat cleared on logout.</div>
  </div>
</div>

<!-- ==================== HISTORY ==================== -->
<div id="page-history" class="page">
  <div style="max-width:900px;margin:24px auto;padding:0 20px">
    <h2 style="font-size:20px;color:var(--text);margin-bottom:16px">Patient History</h2>
    <div style="display:flex;gap:8px;margin-bottom:16px">
      <button class="btn small toggle-active" data-filter="all">All</button>
      <button class="btn small" data-filter="vitals">Vitals</button>
      <button class="btn small" data-filter="analysis">AI Analysis</button>
      <button class="btn small" data-filter="alerts">Alerts</button>
    </div>
    <div id="historyList"><div class="empty-state"><div class="icon">&#128203;</div>No history yet. Use Health Chat or add vitals to build your record.</div></div>
  </div>
</div>

<!-- ==================== DOCTOR ==================== -->
<div id="page-doctor" class="page">
  <div style="max-width:900px;margin:24px auto;padding:0 20px">
    <h2 style="font-size:20px;color:var(--text);margin-bottom:4px">Doctor AI Report</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Generate a comprehensive AI clinical report based on all your stored health data.</p>
    <button class="btn primary" id="genReportBtn" style="max-width:300px">Generate Doctor Report</button>
    <button class="btn" id="genBriefingBtn" style="max-width:300px;margin-left:8px">Audio Briefing</button>
    <div id="doctorReportArea" style="margin-top:20px"><div class="empty-state"><div class="icon">&#129658;</div>Click "Generate Doctor Report" to create an AI clinical summary.</div></div>
    <div id="audioBriefingArea" style="margin-top:16px"></div>
  </div>
</div>

<!-- ==================== FIND DOCTOR (Patient View) ==================== -->
<div id="page-finddoc" class="page">
  <div style="max-width:900px;margin:24px auto;padding:0 20px">
    <h2 style="font-size:20px;color:var(--text);margin-bottom:4px">Find a Specialist Doctor</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px">Browse verified doctors. Request a consultation — they can only see your data after YOU approve.</p>

    <div id="doctorSuggestion"></div>

    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
      <select id="filterSpec" class="doc-reg-field" style="width:auto;margin:0;padding:8px 12px">
        <option value="">All Specializations</option>
        <option value="General Medicine">General Medicine</option>
        <option value="Cardiology">Cardiology</option>
        <option value="Endocrinology">Endocrinology</option>
        <option value="Pulmonology">Pulmonology</option>
        <option value="Dermatology">Dermatology</option>
        <option value="Orthopedics">Orthopedics</option>
        <option value="Neurology">Neurology</option>
      </select>
      <button class="btn small primary" id="refreshDocsBtn">Refresh</button>
    </div>

    <div id="doctorsList"><div class="empty-state"><div class="icon">&#129658;</div>No doctors registered yet. Doctors can register on the login screen.</div></div>

    <h3 style="font-size:16px;color:var(--text);margin:24px 0 12px">My Consultations</h3>
    <div id="myConsultations"><div class="empty-state"><div class="icon">&#128203;</div>No consultations yet. Request one from the doctor list above.</div></div>
  </div>
</div>

<!-- ==================== DOCTOR DASHBOARD (Doctor View) ==================== -->
<div id="page-docdash" class="page">
  <div style="max-width:900px;margin:24px auto;padding:0 20px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px">
      <div>
        <h2 style="font-size:20px;color:var(--text);margin-bottom:4px">Doctor Dashboard</h2>
        <p style="font-size:12px;color:var(--muted)">Manage consultation requests. Patient data is only visible after patient approval.</p>
      </div>
      <div style="text-align:right">
        <div style="font-size:11px;color:var(--accent);font-weight:600" id="docDashName">--</div>
        <div style="font-size:10px;color:var(--muted)" id="docDashSpec">--</div>
      </div>
    </div>

    <h3 style="font-size:14px;color:var(--text);margin-bottom:12px">Consultation Requests</h3>
    <div id="docConsultations"><div class="empty-state"><div class="icon">&#128203;</div>No consultation requests yet. Patients will find you in the doctor directory.</div></div>

    <h3 style="font-size:14px;color:var(--text);margin:24px 0 12px">Patient Data (Approved Only)</h3>
    <div id="docPatientData"><div class="empty-state"><div class="icon">&#128274;</div>Select an approved consultation above to view patient data.</div></div>
  </div>
</div>

<!-- ==================== PRIVACY ==================== -->
<div id="page-privacy" class="page">
  <div style="max-width:900px;margin:24px auto;padding:0 20px">
    <h2 style="font-size:20px;color:var(--text);margin-bottom:4px">Privacy & Data Control</h2>
    <p style="font-size:12px;color:var(--muted);margin-bottom:20px">Full transparency into what data exists, how it's protected, and your rights.</p>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">Data Flow (Zero-Knowledge Architecture)</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;text-align:center;margin-top:12px">
        <div style="padding:10px;background:#ebf8ff;border:1px solid #bee3f8;border-radius:8px"><div style="font-size:22px">&#128248;</div><div style="font-size:10px;font-weight:600;color:var(--accent);margin-top:4px">Your Photo</div><div style="font-size:8px;color:var(--red);font-weight:600">NEVER saved</div></div>
        <div style="padding:10px;background:#f0fff4;border:1px solid #c6f6d5;border-radius:8px"><div style="font-size:22px">&#128300;</div><div style="font-size:10px;font-weight:600;color:var(--green);margin-top:4px">Venice Vision</div><div style="font-size:8px;color:var(--green);font-weight:600">Zero retention</div></div>
        <div style="padding:10px;background:#faf5ff;border:1px solid #e9d8fd;border-radius:8px"><div style="font-size:22px">&#129504;</div><div style="font-size:10px;font-weight:600;color:#6b46c1;margin-top:4px">AkashML</div><div style="font-size:8px;color:#6b46c1;font-weight:600">Text only</div></div>
        <div style="padding:10px;background:#fff7e6;border:1px solid #f6e05e;border-radius:8px"><div style="font-size:22px">&#128272;</div><div style="font-size:10px;font-weight:600;color:var(--yellow);margin-top:4px">AES-256-GCM</div><div style="font-size:8px;color:var(--yellow);font-weight:600">Encrypted</div></div>
        <div style="padding:10px;background:#fff5f5;border:1px solid #fed7d7;border-radius:8px"><div style="font-size:22px">&#128203;</div><div style="font-size:10px;font-weight:600;color:var(--red);margin-top:4px">You See Results</div><div style="font-size:8px;color:var(--red);font-weight:600">Photo GONE</div></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">Live Encryption Proof</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:8px">See the actual encrypted data in the database vs what you see.</div>
      <button class="btn primary" id="loadProofBtn" style="max-width:250px;margin-bottom:12px">Load Encryption Proof</button>
      <div id="proofArea"></div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">What IS and ISN'T Stored</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px">
        <div><div style="font-size:12px;font-weight:600;color:var(--green);margin-bottom:6px">Stored (encrypted)</div><div style="font-size:11px;line-height:1.8">- Patient name (AES-256-GCM)<br>- Vital readings<br>- AI analysis summaries<br>- Alert history<br>- Audit trail (immutable)</div></div>
        <div><div style="font-size:12px;font-weight:600;color:var(--red);margin-bottom:6px">NEVER Stored</div><div style="font-size:11px;line-height:1.8">- Raw photos (deleted immediately)<br>- Raw audio recordings<br>- EXIF/GPS metadata<br>- IP addresses<br>- Chat cleared on logout</div></div>
      </div>
    </div>
    <div class="card" style="margin-bottom:16px">
      <div class="card-title">Your Data Rights</div>
      <div style="display:flex;gap:12px;margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="exportDataBtn" style="width:auto;padding:10px 20px">&#128229; Export All My Data</button>
        <button class="btn" id="deleteDataBtn" style="width:auto;padding:10px 20px;border-color:var(--red);color:var(--red)">&#128465; Delete All My Data</button>
      </div>
      <div id="dataRightsResult" style="margin-top:12px"></div>
    </div>
    <div class="card">
      <div class="card-title">Infrastructure</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:8px">
        <div style="padding:10px;background:#f7fafc;border-radius:6px;text-align:center"><div style="font-size:20px">&#9729;&#65039;</div><div style="font-size:11px;font-weight:600">Akash Network</div><div style="font-size:9px;color:var(--muted)">Decentralized 24/7 compute. No single point of failure.</div></div>
        <div style="padding:10px;background:#f7fafc;border-radius:6px;text-align:center"><div style="font-size:20px">&#128272;</div><div style="font-size:11px;font-weight:600">AES-256-GCM</div><div style="font-size:9px;color:var(--muted)">Military-grade encryption. 100K PBKDF2 iterations.</div></div>
        <div style="padding:10px;background:#f7fafc;border-radius:6px;text-align:center"><div style="font-size:20px">&#128221;</div><div style="font-size:11px;font-weight:600">Immutable Audit</div><div style="font-size:9px;color:var(--muted)">Every action logged. Tamper-evident. Verifiable.</div></div>
      </div>
    </div>
  </div>
</div>

<div class="footer">HealthGuard v2.0 &middot; 24/7 on Akash Network &middot; Venice AI &middot; Zero data retention &middot; Hackathon 2026</div>

</div><!-- /mainApp -->

<script>
var currentPatientId = null;
var currentAccessKey = null;
var currentName = null;
var chatPendingPhoto = null;
var currentRole = 'patient';
var currentDoctorId = null;
var currentDoctorInfo = null;

var $ = function(id) { return document.getElementById(id); };

async function fetchJSON(url) {
    var res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return res.json();
}

// ── AUTH ──
function setAuthTab(tab) {
    ['tabLogin','tabRegister','tabDoctor'].forEach(function(t) { $(t).classList.remove('active'); });
    $(tab).classList.add('active');
    $('loginForm').style.display = tab === 'tabLogin' ? '' : 'none';
    $('registerForm').style.display = tab === 'tabRegister' ? '' : 'none';
    $('doctorForm').style.display = tab === 'tabDoctor' ? '' : 'none';
    $('authMsg').classList.remove('show');
}
$('tabLogin').addEventListener('click', function() { setAuthTab('tabLogin'); });
$('tabRegister').addEventListener('click', function() { setAuthTab('tabRegister'); });
$('tabDoctor').addEventListener('click', function() { setAuthTab('tabDoctor'); });

$('loginBtn').addEventListener('click', async function() {
    var key = $('loginKey').value.trim().toUpperCase();
    if (key.length < 4) { showAuthMsg('Enter your access key', 'error'); return; }
    this.disabled = true; this.textContent = 'Logging in...';
    try {
        // Try patient login first, then doctor
        if (key.startsWith('DR')) {
            var fd = new FormData(); fd.append('access_key', key);
            var r = await fetch('/login-doctor', { method: 'POST', body: fd });
            var d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'Invalid doctor key');
            enterDoctorApp(d);
        } else {
            var fd = new FormData(); fd.append('access_key', key);
            var r = await fetch('/login', { method: 'POST', body: fd });
            var d = await r.json();
            if (!r.ok) throw new Error(d.detail || 'Invalid access key');
            enterApp(d.patient_id, d.access_key, d.name);
        }
    } catch(e) { showAuthMsg(e.message, 'error'); }
    this.disabled = false; this.textContent = 'Login Securely';
});

$('loginKey').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('loginBtn').click(); });

$('regBtn').addEventListener('click', async function() {
    var name = $('regName').value.trim();
    if (!name) { showAuthMsg('Enter your name', 'error'); return; }
    this.disabled = true; this.textContent = 'Registering...';
    try {
        var fd = new FormData(); fd.append('name', name);
        var r = await fetch('/register-patient', { method: 'POST', body: fd });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Registration failed');
        $('newAccessKey').textContent = d.access_key;
        $('regResult').style.display = '';
        $('regBtn').style.display = 'none';
        $('regName').style.display = 'none';
        currentPatientId = d.patient_id;
        currentAccessKey = d.access_key;
        currentName = d.name;
    } catch(e) { showAuthMsg(e.message, 'error'); }
    this.disabled = false; this.textContent = 'Register & Get Access Key';
});

$('regContinueBtn').addEventListener('click', function() {
    enterApp(currentPatientId, currentAccessKey, currentName);
});

function showAuthMsg(msg, type) {
    var el = $('authMsg');
    el.textContent = msg;
    el.className = 'auth-msg show ' + type;
}

function enterApp(pid, key, name) {
    currentPatientId = pid;
    currentAccessKey = key;
    currentName = name;
    currentRole = 'patient';
    $('authOverlay').classList.add('hidden');
    $('mainApp').style.display = '';
    $('userName').textContent = name;
    $('userKey').textContent = key;
    // Show patient nav, hide doctor dashboard
    document.querySelectorAll('#navTabs a').forEach(function(a) { a.style.display = ''; });
    refreshAll();
    loadChatHistory();
    showPage('dashboard');
}

function enterDoctorApp(doc) {
    currentRole = 'doctor';
    currentDoctorId = doc.id;
    currentDoctorInfo = doc;
    currentAccessKey = doc.access_key;
    currentName = doc.name;
    $('authOverlay').classList.add('hidden');
    $('mainApp').style.display = '';
    $('userName').textContent = 'Dr. ' + doc.name;
    $('userKey').textContent = doc.access_key;
    $('docDashName').textContent = 'Dr. ' + doc.name;
    $('docDashSpec').textContent = doc.specialization + ' | ' + doc.email;
    // Show only doctor-relevant nav
    document.querySelectorAll('#navTabs a').forEach(function(a) {
        var p = a.dataset.page;
        a.style.display = (p === 'docdash' || p === 'privacy') ? '' : 'none';
    });
    showPage('docdash');
    refreshDoctorConsultations();
}

// ── LOGOUT ──
$('logoutBtn').addEventListener('click', async function() {
    if (!confirm('Logout?')) return;
    try { if (currentPatientId) await fetch('/clear-chat/' + currentPatientId, { method: 'POST' }); } catch(e) {}
    // Reset ALL state
    currentPatientId = null; currentAccessKey = null; currentName = null;
    currentRole = 'patient'; currentDoctorId = null; currentDoctorInfo = null;
    // Reset UI
    $('authOverlay').classList.remove('hidden');
    $('mainApp').style.display = 'none';
    $('loginKey').value = '';
    // Clear all dynamic content to prevent cross-user data leaks
    var welcome = $('chatWelcome');
    $('chatMessages').innerHTML = '';
    if (welcome) $('chatMessages').appendChild(welcome);
    if (welcome) welcome.style.display = '';
    $('bpChart').innerHTML = '<div class="empty-state"><div class="icon">&#128200;</div>Need at least 2 BP readings</div>';
    $('bpValue').textContent = '--'; $('glucoseValue').textContent = '--';
    $('painValue').textContent = '--'; $('tempValue').textContent = '--';
    $('actionsList').innerHTML = '<div class="empty-state"><div class="icon">&#128276;</div>No alerts yet</div>';
    $('feedList').innerHTML = '<div class="empty-state" style="padding:12px"><div class="icon">&#128225;</div>Events appear here</div>';
    $('recentAnalysis').innerHTML = '<div class="empty-state"><div class="icon">&#128300;</div>No analyses yet</div>';
    $('historyList').innerHTML = '';
    $('doctorReportArea').innerHTML = '<div class="empty-state"><div class="icon">&#129658;</div>Click "Generate Doctor Report" to create an AI clinical summary.</div>';
    $('audioBriefingArea').innerHTML = '';
    $('doctorsList').innerHTML = ''; $('myConsultations').innerHTML = '';
    $('docConsultations').innerHTML = ''; $('docPatientData').innerHTML = '';
    $('doctorSuggestion').innerHTML = '';
    // Reset auth forms
    $('regResult').style.display = 'none';
    $('regBtn').style.display = '';
    $('regName').style.display = '';
    $('regName').value = '';
    $('docRegResult').style.display = 'none';
    $('docRegBtn').style.display = '';
    $('docLoginKey').value = '';
    $('authMsg').classList.remove('show');
    setAuthTab('tabLogin');
});

// ── NAV ──
var ALL_PAGES = ['page-dashboard','page-chat','page-history','page-doctor','page-privacy','page-finddoc','page-docdash'];
function showPage(page) {
    ALL_PAGES.forEach(function(id) { $(id).classList.remove('active'); });
    $('page-' + page).classList.add('active');
    document.querySelectorAll('#navTabs a').forEach(function(a) {
        a.classList.toggle('active', a.dataset.page === page);
    });
    if (page === 'history') refreshHistory();
    if (page === 'chat') { $('chatInput').focus(); }
    if (page === 'finddoc') { refreshDoctorsList(); refreshPatientConsultations(); }
    if (page === 'docdash') { refreshDoctorConsultations(); }
}
document.querySelectorAll('#navTabs a').forEach(function(a) {
    a.addEventListener('click', function(e) { e.preventDefault(); showPage(this.dataset.page); });
});
$('goChat').addEventListener('click', function() { showPage('chat'); });

// ── VITALS ──
function statusFor(metric, val) {
    if (val == null) return 'normal';
    if (metric === 'bp_systolic') return val >= 140 ? 'alert' : val >= 120 ? 'watch' : 'normal';
    if (metric === 'glucose') return val >= 180 ? 'alert' : val >= 100 ? 'watch' : 'normal';
    if (metric === 'pain_level') return val >= 7 ? 'alert' : val >= 4 ? 'watch' : 'normal';
    if (metric === 'temperature') return val >= 100.4 ? 'alert' : val >= 99.5 ? 'watch' : 'normal';
    return 'normal';
}
function setBadge(prefix, status) {
    var map = { normal: 'green', watch: 'yellow', alert: 'red' };
    var b = $(prefix + 'Badge'); if (!b) return;
    b.className = 'badge ' + (map[status] || 'green');
    b.textContent = status.toUpperCase();
    var card = $('card' + prefix.charAt(0).toUpperCase() + prefix.slice(1));
    if (card) { card.className = 'card status-' + status; }
}

async function refreshVitals() {
    if (!currentPatientId || currentRole !== 'patient') return;
    var pid = currentPatientId;
    try {
        var d = await fetchJSON('/patient/' + pid);
        if (pid !== currentPatientId) return; // User switched — discard stale data
        var v = d.latest_vitals || {};
        if (v.bp_systolic) {
            $('bpValue').textContent = Math.round(v.bp_systolic.value) + '/' + (v.bp_diastolic ? Math.round(v.bp_diastolic.value) : '--') + ' mmHg';
            setBadge('bp', statusFor('bp_systolic', v.bp_systolic.value));
        } else { $('bpValue').textContent = '--'; $('bpTrend').textContent = 'No readings yet'; setBadge('bp', 'normal'); }
        if (v.glucose) { $('glucoseValue').textContent = Math.round(v.glucose.value); setBadge('glucose', statusFor('glucose', v.glucose.value)); }
        else { $('glucoseValue').textContent = '--'; setBadge('glucose', 'normal'); }
        if (v.pain_level) { $('painValue').textContent = v.pain_level.value + '/10'; setBadge('pain', statusFor('pain_level', v.pain_level.value)); }
        else { $('painValue').textContent = '--'; setBadge('pain', 'normal'); }
        if (v.temperature) { $('tempValue').textContent = v.temperature.value.toFixed(1) + ' F'; setBadge('temp', statusFor('temperature', v.temperature.value)); }
        else { $('tempValue').textContent = '--'; setBadge('temp', 'normal'); }
        // BP chart
        var hist = (d.vitals_history || []).filter(function(x) { return x.metric_type === 'bp_systolic'; }).slice(0, 14);
        if (hist.length >= 2) renderBpChart(hist); else $('bpChart').innerHTML = '<div class="empty-state"><div class="icon">&#128200;</div>Need at least 2 BP readings</div>';
    } catch(e) {}
}

function renderBpChart(data) {
    data = data.slice().reverse();
    var w = $('bpChart').clientWidth || 400, h = 180;
    var vals = data.map(function(d) { return d.value; });
    var mn = Math.min.apply(null, vals) - 10, mx = Math.max.apply(null, vals) + 10;
    var pts = data.map(function(d, i) {
        var x = 30 + i * ((w - 60) / (data.length - 1 || 1));
        var y = h - 30 - ((d.value - mn) / (mx - mn || 1)) * (h - 50);
        return { x: x, y: y, val: d.value, ts: d.timestamp };
    });
    var path = pts.map(function(p, i) { return (i === 0 ? 'M' : 'L') + p.x + ',' + p.y; }).join(' ');
    var svg = '<svg width="' + w + '" height="' + h + '">';
    svg += '<line x1="30" y1="' + (h - 30) + '" x2="' + (w - 30) + '" y2="' + (h - 30) + '" stroke="#e4ebf3" stroke-width="1"/>';
    svg += '<path d="' + path + '" fill="none" stroke="#1f7a8c" stroke-width="2.5" class="bp-line"/>';
    pts.forEach(function(p) {
        svg += '<circle cx="' + p.x + '" cy="' + p.y + '" r="4" fill="#1f7a8c"/>';
        svg += '<text x="' + p.x + '" y="' + (p.y - 8) + '" text-anchor="middle" font-size="9" fill="#5a6b82">' + Math.round(p.val) + '</text>';
        svg += '<text x="' + p.x + '" y="' + (h - 10) + '" text-anchor="middle" font-size="8" fill="#5a6b82">' + (p.ts || '').substring(5, 10) + '</text>';
    });
    svg += '</svg>';
    $('bpChart').innerHTML = svg;
}

$('vitalType').addEventListener('change', function() {
    $('vitalVal2').style.display = this.value === 'bp' ? '' : 'none';
});

$('addVitalBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    var type = $('vitalType').value, v1 = parseFloat($('vitalVal1').value);
    if (isNaN(v1)) return;
    this.disabled = true; this.textContent = 'Saving...';
    try {
        var calls = [];
        if (type === 'bp') {
            var v2 = parseFloat($('vitalVal2').value);
            if (isNaN(v2)) { this.disabled = false; this.textContent = 'Add'; return; }
            var fd1 = new FormData(); fd1.append('patient_id', currentPatientId); fd1.append('metric_type', 'bp_systolic'); fd1.append('value', v1); fd1.append('unit', 'mmHg');
            var fd2 = new FormData(); fd2.append('patient_id', currentPatientId); fd2.append('metric_type', 'bp_diastolic'); fd2.append('value', v2); fd2.append('unit', 'mmHg');
            calls = [fetch('/vital', { method: 'POST', body: fd1 }), fetch('/vital', { method: 'POST', body: fd2 })];
        } else {
            var fd = new FormData(); fd.append('patient_id', currentPatientId); fd.append('metric_type', type); fd.append('value', v1);
            calls = [fetch('/vital', { method: 'POST', body: fd })];
        }
        await Promise.all(calls);
        $('vitalVal1').value = ''; $('vitalVal2').value = '';
        $('vitalSaveMsg').textContent = 'Saved!';
        setTimeout(function() { $('vitalSaveMsg').textContent = ''; }, 2000);
        // Wait briefly for DB commit before refreshing
        setTimeout(refreshVitals, 500);
    } catch(e) { $('vitalSaveMsg').textContent = 'Error saving'; }
    this.disabled = false; this.textContent = 'Add';
});

// ── ACTIONS & FEED ──
async function refreshActions() {
    if (!currentPatientId || currentRole !== 'patient') return;
    var pid = currentPatientId;
    try {
        var alerts = await fetchJSON('/alerts?patient_id=' + pid + '&limit=10');
        if (pid !== currentPatientId) return;
        if (!alerts.length) { $('actionsList').innerHTML = '<div class="empty-state"><div class="icon">&#128276;</div>No alerts yet</div>'; return; }
        $('actionsList').innerHTML = alerts.map(function(a) {
            var cls = a.severity === 1 ? 'red' : a.severity === 2 ? 'yellow' : 'green';
            return '<div class="action-item ' + cls + '"><div style="display:flex;justify-content:space-between"><strong>sev' + a.severity + '</strong><span>' + (a.timestamp || '').substring(11, 19) + '</span></div><div>' + (a.message || '') + '</div></div>';
        }).join('');
    } catch(e) {}
}

async function refreshFeed() {
    if (!currentPatientId || currentRole !== 'patient') return;
    var pid = currentPatientId;
    try {
        var audit = await fetchJSON('/audit?limit=20');
        if (pid !== currentPatientId) return;
        if (!audit.length) return;
        $('feedList').innerHTML = audit.reverse().map(function(e) {
            return '<div class="feed-item">' + (e.timestamp || '').substring(11, 19) + ' - ' + (e.type || '') + '</div>';
        }).join('');
    } catch(e) {}
}

async function refreshRecentAnalysis() {
    if (!currentPatientId || currentRole !== 'patient') return;
    var pid = currentPatientId;
    try {
        var logs = await fetchJSON('/logs?patient_id=' + pid + '&limit=3');
        if (pid !== currentPatientId) return;
        if (!logs.length) { $('recentAnalysis').innerHTML = '<div class="empty-state"><div class="icon">&#128300;</div>No analyses yet</div>'; return; }
        $('recentAnalysis').innerHTML = logs.map(function(l) {
            var cls = l.anomaly_score >= 0.7 ? 'red' : l.anomaly_score >= 0.4 ? 'yellow' : 'green';
            return '<div style="padding:8px;border-left:3px solid var(--' + cls + ');margin-bottom:6px;font-size:10px;background:#f8fafc;border-radius:4px"><div style="display:flex;justify-content:space-between"><span class="badge ' + cls + '">' + (l.decision || '') + '</span><span style="color:var(--muted)">' + (l.timestamp || '').substring(11, 19) + '</span></div><div style="margin-top:4px;color:var(--text)">' + (l.summary || l.reason || '').substring(0, 150) + '</div></div>';
        }).join('');
    } catch(e) {}
}

async function refreshStatus() {
    try {
        var s = await fetchJSON('/status');
        $('agentStatus').textContent = s.running ? 'RUNNING 24/7' : 'STARTING';
        $('uptime').textContent = s.uptime_seconds ? Math.round(s.uptime_seconds) + 's' : '--';
        $('errorBanner').classList.remove('show');
    } catch(e) { $('errorBanner').classList.add('show'); }
}

function refreshAll() { if (currentRole !== 'patient') return; refreshVitals(); refreshActions(); refreshFeed(); refreshStatus(); refreshRecentAnalysis(); }

// ── HEALTH CHAT ──
async function loadChatHistory() {
    if (!currentPatientId) return;
    try {
        var msgs = await fetchJSON('/chat-history/' + currentPatientId + '?limit=30');
        if (msgs.length > 0) {
            var welcome = $('chatWelcome');
            if (welcome) welcome.style.display = 'none';
            msgs.forEach(function(m) { appendChatBubble(m.role, m.content, m.timestamp); });
            scrollChat();
        }
    } catch(e) {}
}

function appendChatBubble(role, content, ts) {
    var welcome = $('chatWelcome');
    if (welcome) welcome.style.display = 'none';
    var div = document.createElement('div');
    div.className = 'chat-msg ' + role;
    var cleanContent = content.replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>');
    div.innerHTML = cleanContent + '<div class="time">' + (ts ? ts.substring(11, 19) : new Date().toTimeString().substring(0, 8)) + '</div>';
    $('chatMessages').appendChild(div);
}

function scrollChat() { var c = $('chatMessages'); c.scrollTop = c.scrollHeight; }

$('chatSendBtn').addEventListener('click', sendChat);
$('chatInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

function createStreamBubble() {
    var welcome = $('chatWelcome');
    if (welcome) welcome.style.display = 'none';
    var div = document.createElement('div');
    div.className = 'chat-msg assistant';
    div.innerHTML = '<span class="stream-content"></span><div class="time">' + new Date().toTimeString().substring(0,8) + '</div>';
    $('chatMessages').appendChild(div);
    return div.querySelector('.stream-content');
}

async function sendChat() {
    var msg = $('chatInput').value.trim();
    if (!msg && !chatPendingPhoto) return;
    if (!currentPatientId) return;

    // If there's a photo pending, handle photo analysis
    if (chatPendingPhoto) {
        appendChatBubble('user', (msg || 'Please analyze this health photo') + '\n[Photo attached]');
        $('chatInput').value = '';
        scrollChat();
        appendChatBubble('assistant', '🔍 Analyzing image... (one moment)');
        scrollChat();
        try {
            var fd = new FormData();
            fd.append('file', chatPendingPhoto);
            fd.append('patient_id', currentPatientId);
            fd.append('note', msg || '');
            var r = await fetch('/analyze-photo', { method: 'POST', body: fd });
            var d = await r.json();
            // Remove the "Analyzing..." bubble
            var bubbles = document.querySelectorAll('.chat-bubble.assistant');
            if (bubbles.length) bubbles[bubbles.length - 1].remove();
            var t = d.triage || d.vision || {};
            var response = '';
            var lvl = (t.emergency_level || 'unknown').replace(/_/g, ' ').toUpperCase();
            response += '⚕️ Emergency Level: ' + lvl + '\n\n';
            if (t.patient_message) response += t.patient_message + '\n\n';
            if (t.observations) response += '🔎 Observations: ' + t.observations + '\n\n';
            if (t.primary_concern) response += '⚠️ Primary Concern: ' + t.primary_concern + '\n';
            if (t.severity) response += 'Severity: ' + t.severity + ' | Infection Risk: ' + (t.infection_risk || 'unknown') + '\n\n';
            if (t.treatment_plan && t.treatment_plan.length) {
                response += '📋 Treatment Plan:\n';
                t.treatment_plan.forEach(function(s) { response += '• ' + s.action + ' (' + s.timeframe + ')\n'; });
                response += '\n';
            }
            if (t.medications && t.medications.length) {
                response += '💊 Medications:\n';
                t.medications.forEach(function(m) { response += '• ' + m.name + ' ' + (m.dosage||'') + ' (' + m.type + ')\n'; });
                response += '\n';
            }
            if (t.doctor_urgency && t.doctor_urgency !== 'not_needed') response += '🏥 Doctor: See ' + t.doctor_urgency.replace(/_/g, ' ') + '\n';
            appendChatBubble('assistant', response.trim() || 'Analysis complete.');
        } catch(e) {
            var bubbles2 = document.querySelectorAll('.chat-bubble.assistant');
            if (bubbles2.length) bubbles2[bubbles2.length - 1].remove();
            appendChatBubble('assistant', 'Sorry, photo analysis failed: ' + e.message);
        }
        chatPendingPhoto = null;
        $('typingIndicator').classList.remove('show');
        scrollChat();
        refreshVitals();
        return;
    }

    // Text chat — streaming
    appendChatBubble('user', msg);
    $('chatInput').value = '';
    scrollChat();
    $('chatSendBtn').disabled = true;
    var streamEl = createStreamBubble();
    var fullText = '';
    scrollChat();

    try {
        var fd = new FormData();
        fd.append('patient_id', currentPatientId);
        fd.append('message', msg);
        var r = await fetch('/chat-stream', { method: 'POST', body: fd });
        var reader = r.body.getReader();
        var decoder = new TextDecoder();
        var buf = '';
        while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buf += decoder.decode(chunk.value, { stream: true });
            var lines = buf.split('\n');
            buf = lines.pop();
            for (var i = 0; i < lines.length; i++) {
                var line = lines[i].trim();
                if (!line.startsWith('data: ')) continue;
                try {
                    var ev = JSON.parse(line.substring(6));
                    if (ev.t) {
                        fullText += ev.t;
                        streamEl.innerHTML = fullText.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
                        scrollChat();
                    }
                    if (ev.done && ev.vitals_extracted && Object.keys(ev.vitals_extracted).length > 0) {
                        fullText += '\n\n[Vitals auto-saved: ' + Object.entries(ev.vitals_extracted).map(function(e){return e[0]+'='+e[1];}).join(', ') + ']';
                        streamEl.innerHTML = fullText.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
                        refreshVitals();
                    }
                } catch(pe) {}
            }
        }
        if (!fullText) {
            streamEl.innerHTML = 'No response received. Please try again.';
        }
    } catch(e) {
        streamEl.innerHTML = 'Connection error. Please try again.';
    }
    $('chatSendBtn').disabled = false;
    scrollChat();
}

// Save assistant message to chat DB (for photo analysis which bypasses /chat endpoint)
async function _db_save_chat(content) {
    try {
        // The /chat endpoint saves automatically, but photo analysis doesn't
        // We'll just save via a lightweight call
        var fd = new FormData();
        fd.append('patient_id', currentPatientId);
        fd.append('message', '[Photo analysis result saved]');
        // Don't actually call /chat again, the result is already displayed
    } catch(e) {}
}

// Chat suggestions
document.querySelectorAll('.suggestion').forEach(function(s) {
    s.addEventListener('click', function() {
        $('chatInput').value = this.dataset.msg;
        sendChat();
    });
});

// Photo attachment in chat
$('chatAttachBtn').addEventListener('click', function() { $('chatPhotoInput').click(); });
$('chatPhotoInput').addEventListener('change', function() {
    if (this.files && this.files[0]) {
        chatPendingPhoto = this.files[0];
        $('chatInput').placeholder = 'Photo attached: ' + this.files[0].name + ' — add a note or just send';
        $('chatInput').focus();
    }
});

// ── HISTORY ──
async function refreshHistory(filter) {
    if (!currentPatientId) return;
    filter = filter || 'all';
    try {
        var items = [];
        if (filter === 'all' || filter === 'vitals') {
            var vitals = await fetchJSON('/patient/' + currentPatientId + '/vitals?days=30');
            vitals.forEach(function(v) { items.push({ type: 'vital', time: v.timestamp, text: v.metric_type + ': ' + v.value + ' ' + (v.unit || ''), source: v.source }); });
        }
        if (filter === 'all' || filter === 'analysis') {
            var logs = await fetchJSON('/logs?patient_id=' + currentPatientId + '&limit=30');
            logs.forEach(function(l) { items.push({ type: 'analysis', time: l.timestamp, text: (l.summary || l.reason || '').substring(0, 200), decision: l.decision }); });
        }
        if (filter === 'all' || filter === 'alerts') {
            var alerts = await fetchJSON('/alerts?patient_id=' + currentPatientId + '&limit=30');
            alerts.forEach(function(a) { items.push({ type: 'alert', time: a.timestamp, text: a.message, severity: a.severity }); });
        }
        items.sort(function(a, b) { return (b.time || '').localeCompare(a.time || ''); });
        if (!items.length) { $('historyList').innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div>No history yet.</div>'; return; }
        $('historyList').innerHTML = items.slice(0, 50).map(function(it) {
            var color = it.type === 'alert' ? 'var(--red)' : it.type === 'analysis' ? 'var(--accent)' : 'var(--green)';
            return '<div class="history-item"><div style="display:flex;justify-content:space-between;align-items:center"><span class="type" style="background:' + color + '22;color:' + color + '">' + it.type + '</span><span class="time">' + (it.time || '').substring(0, 19) + '</span></div><div style="margin-top:6px;font-size:12px;color:var(--text)">' + (it.text || '') + '</div></div>';
        }).join('');
    } catch(e) {}
}

document.querySelectorAll('[data-filter]').forEach(function(btn) {
    btn.addEventListener('click', function() {
        document.querySelectorAll('[data-filter]').forEach(function(b) { b.classList.remove('toggle-active'); });
        this.classList.add('toggle-active');
        refreshHistory(this.dataset.filter);
    });
});

// ── DOCTOR ──
$('genReportBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    this.disabled = true; this.textContent = 'Generating...';
    try {
        var d = await fetchJSON('/doctor-report/' + currentPatientId);
        var report = d.report || {};
        var h = '';
        for (var key in report) {
            if (typeof report[key] === 'string') h += '<div class="doctor-section"><h3>' + key.replace(/_/g, ' ') + '</h3><p>' + report[key].replace(/\n/g, '<br>') + '</p></div>';
            else h += '<div class="doctor-section"><h3>' + key.replace(/_/g, ' ') + '</h3><p>' + JSON.stringify(report[key], null, 2) + '</p></div>';
        }
        $('doctorReportArea').innerHTML = h || '<div class="empty-state">Report generated but empty.</div>';
    } catch(e) { $('doctorReportArea').innerHTML = '<div style="color:var(--red)">Error: ' + e.message + '</div>'; }
    this.disabled = false; this.textContent = 'Generate Doctor Report';
});

$('genBriefingBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    this.disabled = true; this.textContent = 'Generating...';
    try {
        var d = await fetchJSON('/patient-briefing/' + currentPatientId);
        var h = '<div class="doctor-section"><h3>Patient Briefing</h3><p>' + (d.briefing.spoken_text || JSON.stringify(d.briefing)).replace(/\n/g, '<br>') + '</p></div>';
        if (d.audio_b64) h += '<audio controls src="data:audio/mp3;base64,' + d.audio_b64 + '" style="width:100%;margin-top:8px"></audio>';
        $('audioBriefingArea').innerHTML = h;
    } catch(e) { $('audioBriefingArea').innerHTML = '<div style="color:var(--red)">Error: ' + e.message + '</div>'; }
    this.disabled = false; this.textContent = 'Audio Briefing';
});

// ── PRIVACY ──
$('loadProofBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    this.disabled = true; this.textContent = 'Loading...';
    try {
        var d = await fetchJSON('/privacy-proof/' + currentPatientId);
        var h = '<div style="padding:10px;background:#f0fff4;border:1px solid #c6f6d5;border-radius:6px;margin-bottom:12px">';
        h += '<div style="font-size:11px;font-weight:600;color:var(--green)">Encryption: ' + d.encryption.algorithm + ' | ' + d.encryption.key_derivation + '</div></div>';
        h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">';
        h += '<div style="padding:8px;background:#fff5f5;border:1px solid #fed7d7;border-radius:6px"><div style="font-size:9px;color:var(--red);font-weight:600">ENCRYPTED (stored)</div><div class="mono" style="font-size:8px;word-break:break-all;color:var(--muted);margin-top:4px">' + d.encrypted_proof.patient_name_encrypted + '</div></div>';
        h += '<div style="padding:8px;background:#f0fff4;border:1px solid #c6f6d5;border-radius:6px"><div style="font-size:9px;color:var(--green);font-weight:600">DECRYPTED (you see)</div><div style="font-size:14px;font-weight:600;color:var(--text);margin-top:4px">' + d.encrypted_proof.patient_name_decrypted + '</div></div>';
        h += '</div>';
        h += '<div style="font-size:10px;color:var(--muted)">Images on disk: <strong style="color:var(--green)">' + d.zero_retention.image_files_on_disk + '</strong> | Vitals: ' + d.data_inventory.vitals_stored + ' | Alerts: ' + d.data_inventory.alerts + '</div>';
        $('proofArea').innerHTML = h;
    } catch(e) { $('proofArea').innerHTML = '<div style="color:var(--red)">Error: ' + e.message + '</div>'; }
    this.disabled = false; this.textContent = 'Load Encryption Proof';
});

$('exportDataBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    this.disabled = true;
    try {
        var d = await fetchJSON('/export-my-data/' + currentPatientId);
        var blob = new Blob([JSON.stringify(d, null, 2)], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href = url; a.download = 'healthguard-export.json'; a.click();
        $('dataRightsResult').innerHTML = '<div style="padding:8px;background:#f0fff4;border:1px solid #c6f6d5;border-radius:6px;font-size:11px;color:var(--green)">Exported!</div>';
    } catch(e) { $('dataRightsResult').innerHTML = '<div style="color:var(--red)">' + e.message + '</div>'; }
    this.disabled = false;
});

$('deleteDataBtn').addEventListener('click', async function() {
    if (!currentPatientId) return;
    if (!confirm('DELETE ALL your health data? This cannot be undone.')) return;
    if (!confirm('FINAL WARNING: Everything will be permanently erased.')) return;
    try {
        var r = await fetch('/delete-my-data/' + currentPatientId, { method: 'DELETE' });
        var d = await r.json();
        $('dataRightsResult').innerHTML = '<div style="padding:8px;background:#fff5f5;border:1px solid #fed7d7;border-radius:6px;font-size:11px;color:var(--red)">Deleted: ' + d.vitals_deleted + ' vitals, ' + d.logs_deleted + ' logs, ' + d.alerts_deleted + ' alerts.</div>';
    } catch(e) {}
});

// ── DOCTOR AUTH ──
$('docLoginTab').addEventListener('click', function() {
    this.classList.add('toggle-active'); $('docRegTab').classList.remove('toggle-active');
    $('docLoginPanel').style.display = ''; $('docRegPanel').style.display = 'none';
});
$('docRegTab').addEventListener('click', function() {
    this.classList.add('toggle-active'); $('docLoginTab').classList.remove('toggle-active');
    $('docRegPanel').style.display = ''; $('docLoginPanel').style.display = 'none';
});

$('docLoginBtn').addEventListener('click', async function() {
    var key = $('docLoginKey').value.trim().toUpperCase();
    if (key.length < 4) { showAuthMsg('Enter your doctor access key', 'error'); return; }
    this.disabled = true; this.textContent = 'Logging in...';
    try {
        var fd = new FormData(); fd.append('access_key', key);
        var r = await fetch('/login-doctor', { method: 'POST', body: fd });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Invalid doctor key');
        enterDoctorApp(d);
    } catch(e) { showAuthMsg(e.message, 'error'); }
    this.disabled = false; this.textContent = 'Login as Doctor';
});
$('docLoginKey').addEventListener('keydown', function(e) { if (e.key === 'Enter') $('docLoginBtn').click(); });

$('docRegBtn').addEventListener('click', async function() {
    var name = $('docRegName').value.trim();
    var email = $('docRegEmail').value.trim();
    var spec = $('docRegSpec').value;
    var rate = $('docRegRate').value.trim();
    var cert = $('docRegCert').files[0];
    if (!name || !email || !spec || !rate) { showAuthMsg('Fill all required fields', 'error'); return; }
    if (!cert) { showAuthMsg('Upload your MBBS certificate', 'error'); return; }
    this.disabled = true; this.textContent = 'Registering...';
    try {
        var fd = new FormData();
        fd.append('name', name); fd.append('email', email);
        fd.append('specialization', spec); fd.append('pay_rate', rate);
        fd.append('bio', $('docRegBio').value.trim());
        fd.append('certificate', cert);
        var r = await fetch('/register-doctor', { method: 'POST', body: fd });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Registration failed');
        $('newDocKey').textContent = d.access_key;
        $('docRegResult').style.display = '';
        $('docRegBtn').style.display = 'none';
        currentDoctorId = d.doctor_id;
        currentDoctorInfo = { id: d.doctor_id, name: d.name, specialization: d.specialization, access_key: d.access_key, email: email };
    } catch(e) { showAuthMsg(e.message, 'error'); }
    this.disabled = false; this.textContent = 'Register & Get Doctor Key';
});

$('docRegContinueBtn').addEventListener('click', function() {
    enterDoctorApp(currentDoctorInfo);
});

// ── DOCTOR DIRECTORY (Patient View) ──
async function refreshDoctorsList() {
    if (currentRole !== 'patient') return;
    try {
        var spec = $('filterSpec').value;
        var url = '/doctors' + (spec ? '?specialization=' + encodeURIComponent(spec) : '');
        var docs = await fetchJSON(url);
        if (!docs.length) { $('doctorsList').innerHTML = '<div class="empty-state"><div class="icon">&#129658;</div>No doctors found. Doctors can register on the login screen.</div>'; return; }
        $('doctorsList').innerHTML = docs.map(function(d) {
            var initials = d.name.split(' ').map(function(n) { return n[0]; }).join('').substring(0, 2);
            return '<div class="doc-card" style="margin-bottom:10px">' +
                '<div class="avatar">' + initials + '</div>' +
                '<div class="info">' +
                    '<div class="name">Dr. ' + d.name + '</div>' +
                    '<div class="spec">' + d.specialization + '</div>' +
                    '<div class="meta"><span>&#9993; ' + d.email + '</span>' + (d.verified ? '<span style="color:var(--green)">&#10003; Verified</span>' : '<span style="color:var(--yellow)">Pending</span>') + '</div>' +
                    '<div class="rate">' + d.pay_rate + '</div>' +
                    (d.bio ? '<div style="font-size:11px;color:var(--muted);margin-top:4px">' + d.bio + '</div>' : '') +
                '</div>' +
                '<div class="actions">' +
                    '<button class="btn small primary" onclick="requestConsultation(\'' + d.id + '\',\'' + d.name.replace(/'/g, '') + '\',\'' + d.specialization + '\')">Request Consultation</button>' +
                '</div>' +
            '</div>';
        }).join('');
        // Check if patient has alert-level vitals and suggest doctors
        loadDoctorSuggestions();
    } catch(e) {}
}
$('refreshDocsBtn').addEventListener('click', refreshDoctorsList);
$('filterSpec').addEventListener('change', refreshDoctorsList);

async function loadDoctorSuggestions() {
    if (!currentPatientId) return;
    try {
        var d = await fetchJSON('/suggest-doctors/' + currentPatientId);
        if (d.patient_issues && d.patient_issues.length && d.suggested_doctors && d.suggested_doctors.length) {
            var h = '<div class="alert-suggest"><div class="title">&#9888; Based on your health data, we recommend seeing a specialist:</div>';
            h += '<div style="font-size:11px;color:var(--muted);margin-bottom:8px">Issues detected: ' + d.patient_issues.join(', ') + '</div>';
            h += d.suggested_doctors.slice(0, 3).map(function(doc) {
                return '<div style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fff;border-radius:6px;margin-bottom:4px">' +
                    '<div><strong style="font-size:12px">Dr. ' + doc.name + '</strong> <span style="font-size:10px;color:var(--accent)">' + doc.specialization + '</span> <span style="font-size:10px;color:var(--green)">' + doc.pay_rate + '</span></div>' +
                    '<button class="btn small primary" onclick="requestConsultation(\'' + doc.id + '\',\'' + doc.name.replace(/'/g, '') + '\',\'' + doc.specialization + '\')">Request</button>' +
                '</div>';
            }).join('');
            h += '</div>';
            $('doctorSuggestion').innerHTML = h;
        } else {
            $('doctorSuggestion').innerHTML = '';
        }
    } catch(e) {}
}

async function requestConsultation(doctorId, doctorName, spec) {
    var problem = prompt('Describe your health concern for Dr. ' + doctorName + ' (' + spec + '):');
    if (!problem) return;
    try {
        var fd = new FormData();
        fd.append('patient_id', currentPatientId);
        fd.append('doctor_id', doctorId);
        fd.append('problem', problem);
        var r = await fetch('/request-consultation', { method: 'POST', body: fd });
        var d = await r.json();
        if (!r.ok) throw new Error(d.detail || 'Request failed');
        alert('Consultation requested! Dr. ' + doctorName + ' will see your request. They CANNOT see your data until you approve.');
        refreshPatientConsultations();
    } catch(e) { alert('Error: ' + e.message); }
}

// ── PATIENT CONSULTATIONS ──
async function refreshPatientConsultations() {
    if (!currentPatientId || currentRole !== 'patient') return;
    try {
        var consults = await fetchJSON('/consultations/patient/' + currentPatientId);
        if (!consults.length) { $('myConsultations').innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div>No consultations yet.</div>'; return; }
        $('myConsultations').innerHTML = consults.map(function(c) {
            var statusCls = c.status || 'requested';
            var actions = '';
            if (c.status === 'requested') {
                actions = '<div style="margin-top:8px;display:flex;gap:8px">' +
                    '<button class="btn small primary" onclick="approveConsultation(\'' + c.id + '\')">Approve Data Access</button>' +
                    '<button class="btn small" onclick="denyConsultation(\'' + c.id + '\')" style="border-color:var(--red);color:var(--red)">Deny</button>' +
                '</div>' +
                '<div style="font-size:9px;color:var(--muted);margin-top:4px">Doctor cannot see your data until you approve.</div>';
            }
            return '<div class="consult-card">' +
                '<div style="display:flex;justify-content:space-between;align-items:center">' +
                    '<div><strong style="font-size:13px">Dr. ' + (c.doctor_name || 'Unknown') + '</strong> <span style="font-size:10px;color:var(--accent)">' + (c.specialization || '') + '</span></div>' +
                    '<span class="status-tag ' + statusCls + '">' + c.status + '</span>' +
                '</div>' +
                '<div style="font-size:11px;color:var(--muted);margin-top:4px">Concern: ' + (c.problem || 'N/A') + '</div>' +
                (c.doctor_notes ? '<div style="font-size:11px;margin-top:6px;padding:8px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:6px"><strong style="color:var(--green)">Doctor\'s Notes:</strong> ' + c.doctor_notes + '</div>' : '') +
                '<div style="font-size:9px;color:var(--muted);margin-top:4px">' + (c.doc_email || '') + ' | ' + (c.pay_rate || '') + ' | ' + (c.created_at || '').substring(0, 16) + '</div>' +
                actions +
            '</div>';
        }).join('');
    } catch(e) {}
}

async function approveConsultation(cid) {
    if (!confirm('Allow this doctor to see your health data for this consultation?')) return;
    try {
        var r = await fetch('/consultation/' + cid + '/approve', { method: 'POST' });
        var d = await r.json();
        alert(d.message || 'Approved');
        refreshPatientConsultations();
    } catch(e) { alert('Error: ' + e.message); }
}

async function denyConsultation(cid) {
    if (!confirm('Deny this consultation? Doctor will not be able to see your data.')) return;
    try {
        var r = await fetch('/consultation/' + cid + '/deny', { method: 'POST' });
        var d = await r.json();
        alert(d.message || 'Denied');
        refreshPatientConsultations();
    } catch(e) { alert('Error: ' + e.message); }
}

// ── DOCTOR DASHBOARD ──
async function refreshDoctorConsultations() {
    if (!currentDoctorId || currentRole !== 'doctor') return;
    try {
        var consults = await fetchJSON('/consultations/doctor/' + currentDoctorId);
        if (!consults.length) { $('docConsultations').innerHTML = '<div class="empty-state"><div class="icon">&#128203;</div>No requests yet. Patients will find you in the directory.</div>'; return; }
        $('docConsultations').innerHTML = consults.map(function(c) {
            var statusCls = c.status || 'requested';
            var actions = '';
            if (c.patient_approved) {
                actions = '<div style="margin-top:8px;display:flex;gap:8px">' +
                    '<button class="btn small primary" onclick="viewPatientData(\'' + c.id + '\')">View Patient Data</button>' +
                    '<button class="btn small" onclick="addDoctorNotes(\'' + c.id + '\')">Add Notes/Prescription</button>' +
                '</div>';
            } else if (c.status === 'requested') {
                actions = '<div style="font-size:10px;color:var(--yellow);margin-top:6px;padding:6px;background:#fff7e6;border-radius:4px">&#128274; Waiting for patient to approve data access...</div>';
            } else if (c.status === 'denied') {
                actions = '<div style="font-size:10px;color:var(--red);margin-top:6px">Patient denied data access.</div>';
            }
            return '<div class="consult-card">' +
                '<div style="display:flex;justify-content:space-between;align-items:center">' +
                    '<div><strong style="font-size:13px">Patient ID: ' + c.patient_id.substring(0, 12) + '...</strong></div>' +
                    '<span class="status-tag ' + statusCls + '">' + c.status + '</span>' +
                '</div>' +
                '<div style="font-size:11px;color:var(--muted);margin-top:4px">Concern: ' + (c.problem || 'N/A') + '</div>' +
                '<div style="font-size:9px;color:var(--muted);margin-top:2px">' + (c.created_at || '').substring(0, 16) + '</div>' +
                actions +
            '</div>';
        }).join('');
    } catch(e) {}
}

async function viewPatientData(consultId) {
    try {
        var d = await fetchJSON('/consultation/' + consultId + '/patient-data');
        var h = '<div class="card" style="margin-bottom:12px"><div class="card-title">Patient: ' + (d.patient ? d.patient.name : 'Unknown') + '</div>';
        h += '<div style="font-size:10px;color:var(--accent);margin-bottom:8px">Access: ' + (d.access_reason || '') + '</div>';
        // Vitals
        if (d.vitals && d.vitals.length) {
            h += '<div style="font-size:12px;font-weight:600;margin-bottom:6px">Vitals (' + d.vitals.length + ' records)</div>';
            h += '<div style="display:grid;gap:4px;margin-bottom:12px">';
            d.vitals.slice(0, 20).forEach(function(v) {
                h += '<div style="font-size:10px;padding:4px 8px;background:#f8fafc;border-radius:4px">' + v.metric_type + ': <strong>' + v.value + '</strong> ' + (v.unit || '') + ' <span style="color:var(--muted)">' + (v.timestamp || '').substring(0, 16) + '</span></div>';
            });
            h += '</div>';
        }
        // Alerts
        if (d.alerts && d.alerts.length) {
            h += '<div style="font-size:12px;font-weight:600;margin-bottom:6px">Alerts</div>';
            d.alerts.slice(0, 10).forEach(function(a) {
                h += '<div style="font-size:10px;padding:4px 8px;background:#fff5f5;border-left:3px solid var(--red);border-radius:4px;margin-bottom:4px"><strong>Sev ' + a.severity + ':</strong> ' + (a.message || '') + '</div>';
            });
        }
        // Logs
        if (d.analysis_logs && d.analysis_logs.length) {
            h += '<div style="font-size:12px;font-weight:600;margin:8px 0 6px">AI Analysis Logs</div>';
            d.analysis_logs.slice(0, 5).forEach(function(l) {
                h += '<div style="font-size:10px;padding:4px 8px;background:#ebf8ff;border-radius:4px;margin-bottom:4px">' + (l.summary || l.reason || '').substring(0, 200) + '</div>';
            });
        }
        h += '</div>';
        $('docPatientData').innerHTML = h;
    } catch(e) {
        $('docPatientData').innerHTML = '<div style="color:var(--red);font-size:12px">Access denied: ' + e.message + '</div>';
    }
}

async function addDoctorNotes(consultId) {
    var notes = prompt('Enter your notes/prescription for this patient:');
    if (!notes) return;
    try {
        var fd = new FormData(); fd.append('notes', notes);
        var r = await fetch('/consultation/' + consultId + '/notes', { method: 'POST', body: fd });
        var d = await r.json();
        alert(d.message || 'Notes saved');
        refreshDoctorConsultations();
    } catch(e) { alert('Error: ' + e.message); }
}

// ── AUTO REFRESH ──
setInterval(refreshStatus, 5000);
setInterval(function() { if (currentPatientId) { refreshActions(); refreshFeed(); } }, 15000);
setInterval(function() { if (currentPatientId) refreshVitals(); }, 10000);
</script>
</body>
</html>
